<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Form - Book Exchange</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-container > h2 {
            color: #f1c40f;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }

        .form-left {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 30px;
        }

        label {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-control {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            height: 45px;
            font-size: 15px;
        }

        select.form-control {
            height: 45px;
        }

        h6 {
            color: #f1c40f;
            margin-top: 20px;
        }
        
        .submit-btn {
            background-color: #f1c40f;
            color: #fff;
            padding: 10px 25px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background-color: #e2b607;
            transform: translateY(-2px);
        }

        .alert {
            margin-top: 20px;
            border-radius: 8px;
        }

        .profile-pic {
            border: 3px solid #f1c40f;
            border-radius: 50%;
            object-fit: cover;
        }

        .upload-btn {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container form-container">
        <h2>Registration - Book Exchange</h2>
        <div class="row g-0">
            <!-- Left Side -->
            <div class="col-md-4 form-left">
                <div class="content">
                    <img src="Assets/registration_imag_(2).png" class="img-fluid" alt="registration-img" style="max-width: 100%; height: auto;">
                </div>
            </div>

            <!-- Right Side Form -->
            <div class="col-md-8 p-4">
                <form id="registrationForm">
                    <div id="message" class="alert" style="display: none;"></div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name:*</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email:*</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password:*</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Confirm Password:*</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" id="city" name="city">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Address:</label>
                            <input type="text" class="form-control" id="address" name="address">
                        </div>
                        
                    </div>

                    <!-- Profile Picture Upload -->
                    <div class="mt-3">
                        <h6>Upload Profile Picture</h6>
                        <img id="preview" src="https://via.placeholder.com/150" alt="Profile Picture"
                            class="profile-pic" style="width: 150px; height: 150px;">
                        <br>
                        <div>
                            <input type="file" id="profilePic" accept="image/*" class="upload-btn form-control">
                        </div>
                    </div>

                    <button type="submit" class="btn submit-btn mt-4">Register</button>
                    
                    <p class="mt-3">
                        Already have an account? <a href="login.php" style="color: #f1c40f;">Login here</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- YAHAN JAVASCRIPT CODE -->
<script>
    const fileInput = document.getElementById('profilePic');
    const previewImg = document.getElementById('preview');
    const form = document.getElementById('registrationForm');
    const messageDiv = document.getElementById('message');

    // Image preview functionality
    fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImg.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // Form submission
    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        
        console.log("Form submitted - starting registration process");
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Registering...';

        // Basic validation
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        if (password !== confirmPassword) {
            showMessage('Passwords do not match!', 'danger');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Register';
            return;
        }

        if (password.length < 6) {
            showMessage('Password must be at least 6 characters long!', 'danger');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Register';
            return;
        }

        // Prepare form data
        const formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            password: password,
            confirm_password: confirmPassword,
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            profile_picture: ''
        };

        console.log("Sending registration data:", formData);

        try {
            const API_URL = 'http://localhost/book-exchange/register.php';
            console.log("Calling API:", API_URL);
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
                mode: 'cors'
            });

            console.log("Response status:", response.status);
            
            // Get response as text first
            const responseText = await response.text();
            console.log("Raw response:", responseText);

            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error("JSON Parse Error:", parseError);
                throw new Error("Server returned invalid response");
            }

            if (response.ok) {
                showMessage(result.message + ' Redirecting to dashboard...', 'success');
                
                // Store user data in localStorage for dashboard
                const userData = {
                    user_id: result.user_id,
                    name: result.name,
                    email: result.email,
                    loggedIn: true
                };
                
                localStorage.setItem('user', JSON.stringify(userData));
                
                // Redirect to dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                
            } else {
                showMessage(result.message || 'Registration failed. Please try again.', 'danger');
            }

        } catch (error) {
            console.error('Error Details:', error);
            
            let errorMessage = 'Error: ' + error.message;
            
            if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Cannot connect to server. Please check if XAMPP Apache is running.';
            } else if (error.message.includes('invalid response')) {
                errorMessage = 'Server error occurred. Please try again later.';
            }
            
            showMessage(errorMessage, 'danger');
            
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Register';
        }
    });

    function showMessage(message, type) {
        messageDiv.style.display = 'block';
        messageDiv.textContent = message;
        messageDiv.className = `alert alert-${type}`;
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    // Password strength check
    document.getElementById('password').addEventListener('input', function() {
        const password = this.value;
        const strengthText = document.getElementById('password-strength') || 
                            document.createElement('small');
        
        if (!document.getElementById('password-strength')) {
            strengthText.id = 'password-strength';
            strengthText.className = 'form-text';
            this.parentNode.appendChild(strengthText);
        }

        if (password.length === 0) {
            strengthText.textContent = '';
        } else if (password.length < 6) {
            strengthText.textContent = 'Weak - at least 6 characters needed';
            strengthText.style.color = 'red';
        } else if (password.length < 8) {
            strengthText.textContent = 'Medium';
            strengthText.style.color = 'orange';
        } else {
            strengthText.textContent = 'Strong';
            strengthText.style.color = 'green';
        }
    });

    // Test API connection on page load
    window.addEventListener('load', function() {
        console.log("Registration page loaded");
        
        // Check if user is already logged in
        const userData = JSON.parse(localStorage.getItem('user'));
        if (userData && userData.loggedIn) {
            showMessage('You are already logged in. Redirecting to dashboard...', 'info');
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 2000);
        }
    });
</script>
</body>
</html>